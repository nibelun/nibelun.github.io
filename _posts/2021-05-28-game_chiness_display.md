---
title: 【GMS】文本乱码
date: 2021-05-28 05:06:00 +0800
categories: [game]
tags: [game]
seo: date_modified: 2021-05-28 05:06:00 +0800
---

------------

文字部分待解决问题

~~输出中文字符~~
文字加载动画
文字颜色设置
文字翻页
对话框适配（宽高与定位适配）
对话框sprit绘制
对话框插入头像与小图标图片

------------

GMS的文字绘制并没有想象中那么简单——一个函数传入一串文本就完事了。

官方的教学视频讲解很简单

```
draw_self();
draw_set_font(mytf);
draw_text(x, y, "hellp");
```

这种写法仅适用于普通的英文内容。但如果切换到中文或者其他超出ASCII范围的字符时，就会出现异常。
![2021052808](/assets/img/post/2021052808.png)
异常时会出现两种情况：
1.字符直接没有，类似于图片中这种情况。
2.字符显示成▯（默认字符）。
第一种情况属于字符Unicode不在字体文件的range范围中（为何要设置Range后面会有大概解释）。
第二种情况属于字体无法识别，例如使用一些ttf不支持中文日文的时候，文本输出中文日文时就会被默认字符给替代。

问题二还好解决——只需要把支持对应语言的字体复制到资源列表里就可以。
但问题一很麻烦。
中文的编码考虑到简体和繁体还有中日混合的汉字，存在有多套字符集表。
[CJK_Unified_Ideographs](https://en.wikipedia.org/wiki/CJK_Unified_Ideographs "CJK_Unified_Ideographs")
如果要囊括所有的中文字符集 `4E00-62FF, 6300-77FF, 7800-8CFF, 8D00-9FFF.`，则4E00至9FFF之间总共好几万个……

最开始我并不理解为何需要设置字符集range，直到我把range设置成从19968至40959后，当我点击保存运行时，程序炸了，无响应了一段时间……
![2021052802](/assets/img/post/2021052802.png)

我一开始不清楚发生了什么，想着估计是在做什么大量运算。
紧接着强制退出又重新设置了好几回，外加等待了一段时间以后，终于成功了，虽然有一个似乎是出错的提示，不过看上去似乎并不影响运行？
![2021052803](/assets/img/post/2021052803.png)

怀着激动的心情，我点开调试，结果文字直接变成了马赛克……
![2021052801](/assets/img/post/2021052801.png)

很是郁闷，我不知道发生了什么。期间我尝试过看论坛是否有类似的人遇到和我一样的问题，但是得到的回复都是使用 `font_add` 以及使用支持UTF8编码（GMS不支持UTF16）的字体，官方的文档中也并未提到类似case，其他搜索到的结果也说明得含糊不清。
几经尝试过依旧问题没有得到解决。直到我注意到字体设置里有regenerate和copy两个信息……
![2021052809](/assets/img/post/2021052809.png)

尝试过把字体资源拷贝到项目中后，我大概明白了字体绘制的大概思路——先将所有文字都以texture的方式按照range的范围预设（regenerate），然后游戏中的文字绘制均以texture生成好了的图片来进行。这终于算是解释了之前程序卡死的原因，字符范围过大的时候，映射与绘制工作确实需要进行大量的计算。上万个字典绘制出来的图片接近8M，这的确会在游戏渲染的过程中会产生性能问题，所以之前regenerate遇到得警告提示字符数量过大被裁剪也情有可原，也能解释为何调试时遇到马赛克的问题了。
![2021052804](/assets/img/post/2021052804.png)

要一个个把游戏中使用过的字符录入到range列表显然不现实。
GMS则直接支持从代码中导入range（甚至解决了range合并的情况）。
![2021052805](/assets/img/post/2021052805.png)

几经周转之后，中文总算是顺利现实出来了……
![2021052806](/assets/img/post/2021052806.png)
![2021052807](/assets/img/post/2021052807.png)

不得不感慨，看似简单的文字显示背后有如此实现……
汉字乱码问题搞定，下一个目标是文字加载动画！