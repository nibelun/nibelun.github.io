---
title: 【GMS】简易文本引擎——文本乱码
date: 2021-05-28 05:06:00 +0800
categories: [game]
tags: [game]
seo:
  date_modified: 2021-05-28 06:18:38 +0800

---

------------

### 文字部分TODOLIST ###

- ~~输出中文字符~~
- 文字加载动画
- 文字颜色设置
- 文字翻页
- 对话框适配（宽高与定位适配）
- 对话框sprit绘制
- 对话框插入头像与小图标图片

------------

GMS的文字绘制并没有想象中那么简单——一个函数传入一串文本就完事了。

官方的教学视频讲解很简单

```
draw_self();
draw_set_font(mytf);
draw_text(x, y, "hellp");
```

这种写法仅适用于普通的英文内容。但如果切换到中文或者其他超出ASCII范围的字符时，就会出现异常。
![2021052808](/assets/img/post/2021052808.png)
异常时会出现两种情况：
1.字符直接没有，类似于图片中这种情况。
2.字符显示成▯（默认字符）。

第一种情况属于字符Unicode不在字体文件的range范围中（为何要设置Range后面会有大概解释）。
第二种情况属于字体无法识别，例如使用一些ttf不支持中文日文的时候，文本输出中文日文时就会被默认字符给替代。

问题二还好解决——只需要把支持对应语言的字体复制到资源列表里就可以。
但问题一很麻烦。
中文的编码考虑到简体和繁体还有中日混合的汉字，存在有多套字符集表。
[CJK_Unified_Ideographs](https://en.wikipedia.org/wiki/CJK_Unified_Ideographs "CJK_Unified_Ideographs")
如果要囊括所有的中文字符集 `4E00-62FF, 6300-77FF, 7800-8CFF, 8D00-9FFF.`，则4E00至9FFF之间总共好几万个……

最开始我并不理解为何需要设置字符集range，直到我把range设置成从19968至40959后，当我点击保存运行时，程序炸了，无响应了一段时间……
![2021052802](/assets/img/post/2021052802.png)

我一开始不清楚发生了什么，想着估计是在做什么大量运算。
紧接着强制退出又重新设置了好几回，外加等待了一段时间以后，终于成功了，虽然有一个似乎是出错的提示，不过看上去似乎并不影响运行？
![2021052803](/assets/img/post/2021052803.png)

怀着激动的心情，我点开调试，结果文字直接变成了马赛克……
![2021052801](/assets/img/post/2021052801.png)

很是郁闷，我不知道发生了什么。期间我尝试过看论坛是否有类似的人遇到和我一样的问题，但是得到的回复都是使用 `font_add` 以及使用支持UTF8编码（GMS不支持UTF16）的字体，官方的文档中也并未提到类似case，其他搜索到的结果也说明得含糊不清。
[japanese-font-in-game-maker](https://forum.yoyogames.com/index.php?threads/japanese-font-in-game-maker.46332/)

几经尝试过依旧问题没有得到解决。直到我注意到字体设置里有regenerate和copy两个信息……
![2021052809](/assets/img/post/2021052809.png)

尝试过把字体资源拷贝到项目中后，我大概明白了字体绘制的大概思路——先将所有文字都以texture的方式按照range的范围预设（regenerate），然后游戏中的文字绘制均以texture生成好了的图片来进行。

使用这种方式处理字体，不论程序移植到任何平台发布，都不会因为字体不兼容的问题造成异常。但这么做则需要提前将所有的字体都以“字典”的方式提前处理成图片，届时需要输出则再按照之前的“字典”查找指定位置后拉出来使用。
[https://forum.yoyogames.com/index.php?threads/how-to-support-all-characters.62972/](https://forum.yoyogames.com/index.php?threads/how-to-support-all-characters.62972/#post-377897)

这终于算是解释了之前程序卡死的原因，字符范围过大的时候，映射与绘制工作确实需要进行大量的计算。上万个字典绘制出来的图片接近8M，以及上万个字典映射，确实程序需要宕机一段时间……
![2021052804](/assets/img/post/2021052804.png)

**然而默认情况下，texture的大小是有所限制的。若绘制后texture的大小超出了预设范围，则读取texture的过程会产生压缩与扩大，因此会造成一定程度的失真，这大概也就是马赛克产生的原因了。**
![2021052810](/assets/img/post/2021052810.png)

### 解决方法——运行时创建

直接使用`font_add`函数，简单方便。但需要注意若系统不存在对应的字体时，需要讲字体文件打包到游戏包中使用该函数访问字体文件（ttf）。

若`font_add`的`first`和`end`形参设置（range）过大，则会出现游戏运行时每说一句话都会卡顿一段时间（每次都会生成texture）。**因此不推荐使用此方法处理unicode范围过大的语言**

### 解决方法——批量导入

要一个个把游戏中使用过的字符录入到range列表显然不现实。
GMS则直接支持从代码中导入range（甚至解决了range合并的情况）。
![2021052805](/assets/img/post/2021052805.png)

几经周转之后，中文总算是顺利现实出来了……
![2021052806](/assets/img/post/2021052806.png)
![2021052807](/assets/img/post/2021052807.png)

**这种做法是论坛中大部分人推荐的做法，性能比后一种方法更优。但若在开发后期需要汉化校准，经常需要反复修改文字的情况下，需要反复使用源代码进行range更新，相当不方便。**

### 解决方法——预生成

直接把所有的文字都一次性导入，提前生称好所有的映射关系。
![2021052811](/assets/img/post/2021052811.png)

这种做法算是一劳永逸的做法，一次生成成功，后续可以使用所有range内字符。但也需要注意的是，若range的设置过大，**regenerate的运行会需要一段时间，即程序会有一段时间不响应**。等待他计算完毕即可，不要强制退出程序。

若生成结束后出现如下图所示的弹窗，提示texture超出限制，则需要重新调整texture的预设尺寸。（通常情况下不需要进行该选项的额外调整，暂时未评估此调整会带来多大的性能损耗）
![2021052803](/assets/img/post/2021052803.png)
![2021052811](/assets/img/post/2021052812.png)

### 结尾

不得不感慨，看似简单的文字显示背后有如此实现……
汉字乱码问题搞定，下一个目标是文字加载动画！
